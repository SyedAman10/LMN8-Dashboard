{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 79, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/erpai/projects/UI/luminate-clinician/src/lib/db.js"],"sourcesContent":["import { Pool } from '@neondatabase/serverless';\nimport dotenv from 'dotenv';\n\n// Load environment variables\ndotenv.config({ path: '.env.local' });\n\n// Get database connection string\nconst connectionString = process.env.DATABASE_URL || process.env.NEON_DATABASE_URL;\n\nif (!connectionString) {\n  console.error('❌ DATABASE_URL environment variable is not set!');\n  console.error('Please set DATABASE_URL in your .env.local file with your Neon database connection string.');\n  console.error('Example: DATABASE_URL=postgresql://username:password@ep-xxx-xxx.us-east-1.aws.neon.tech/neondb?sslmode=require');\n}\n\n// Create a connection pool\nconst pool = new Pool({\n  connectionString: connectionString,\n});\n\n// Test the database connection\nexport async function testConnection() {\n  try {\n    const client = await pool.connect();\n    const result = await client.query('SELECT NOW()');\n    client.release();\n    console.log('Database connected successfully:', result.rows[0]);\n    return true;\n  } catch (error) {\n    console.error('Database connection failed:', error);\n    return false;\n  }\n}\n\n// Execute a query with error handling\nexport async function query(text, params) {\n  if (!connectionString) {\n    throw new Error('Database connection string not configured. Please set DATABASE_URL environment variable.');\n  }\n  \n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result;\n  } catch (error) {\n    console.error('Database query error:', error);\n    console.error('Query:', text);\n    console.error('Params:', params);\n    throw error;\n  } finally {\n    client.release();\n  }\n}\n\n// Initialize database schema\nexport async function initDatabase() {\n  try {\n    // Check if database is configured\n    if (!connectionString) {\n      throw new Error('Database connection string not configured. Please set DATABASE_URL environment variable.');\n    }\n\n    console.log('🔍 Checking database connection...');\n    const connected = await testConnection();\n    if (!connected) {\n      throw new Error('Database connection failed');\n    }\n\n    console.log('📋 Initializing database schema...');\n    \n    // Create users table first\n    console.log('   Creating users table...');\n    await query(`\n      CREATE TABLE IF NOT EXISTS users (\n        id SERIAL PRIMARY KEY,\n        email VARCHAR(255) UNIQUE NOT NULL,\n        password_hash VARCHAR(255) NOT NULL,\n        first_name VARCHAR(100) NOT NULL,\n        last_name VARCHAR(100) NOT NULL,\n        role VARCHAR(50) NOT NULL,\n        license_number VARCHAR(100),\n        is_active BOOLEAN DEFAULT true,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `);\n    console.log('   ✅ Users table created');\n\n    // Create sessions table for JWT session management\n    console.log('   Creating user_sessions table...');\n    await query(`\n      CREATE TABLE IF NOT EXISTS user_sessions (\n        id SERIAL PRIMARY KEY,\n        user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,\n        session_token VARCHAR(255) UNIQUE NOT NULL,\n        expires_at TIMESTAMP NOT NULL,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `);\n    console.log('   ✅ User sessions table created');\n\n    // Create patients table\n    console.log('   Creating patients table...');\n    await query(`\n      CREATE TABLE IF NOT EXISTS patients (\n        id SERIAL PRIMARY KEY,\n        user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,\n        name VARCHAR(255) NOT NULL,\n        email VARCHAR(255),\n        phone VARCHAR(20),\n        date_of_birth DATE,\n        diagnosis TEXT,\n        medical_history TEXT,\n        emergency_contact VARCHAR(255),\n        emergency_phone VARCHAR(20),\n        therapist VARCHAR(255),\n        total_sessions INTEGER DEFAULT 12,\n        sessions_completed INTEGER DEFAULT 0,\n        status VARCHAR(50) DEFAULT 'active',\n        notes TEXT,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `);\n    console.log('   ✅ Patients table created');\n\n    // Create patient_users table for patient authentication\n    console.log('   Creating patient_users table...');\n    await query(`\n      CREATE TABLE IF NOT EXISTS patient_users (\n        id SERIAL PRIMARY KEY,\n        patient_id INTEGER REFERENCES patients(id) ON DELETE CASCADE,\n        username VARCHAR(50) UNIQUE NOT NULL,\n        password_hash VARCHAR(255) NOT NULL,\n        is_active BOOLEAN DEFAULT true,\n        last_login TIMESTAMP,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `);\n    console.log('   ✅ Patient users table created');\n\n    // Create indexes for better performance\n    console.log('   Creating indexes...');\n    try {\n      await query(`CREATE INDEX IF NOT EXISTS idx_users_email ON users(email)`);\n      await query(`CREATE INDEX IF NOT EXISTS idx_sessions_token ON user_sessions(session_token)`);\n      await query(`CREATE INDEX IF NOT EXISTS idx_patients_user_id ON patients(user_id)`);\n      await query(`CREATE INDEX IF NOT EXISTS idx_patient_users_username ON patient_users(username)`);\n      await query(`CREATE INDEX IF NOT EXISTS idx_patient_users_patient_id ON patient_users(patient_id)`);\n      console.log('   ✅ Indexes created');\n    } catch (indexError) {\n      console.log('   ⚠️  Some indexes may already exist:', indexError.message);\n    }\n\n    console.log('✅ Database schema initialized successfully');\n    return true;\n  } catch (error) {\n    console.error('❌ Database initialization failed:', error);\n    console.error('Error details:', {\n      message: error.message,\n      code: error.code,\n      detail: error.detail\n    });\n    throw error;\n  }\n}\n\nexport default pool;\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;;;AAEA,6BAA6B;AAC7B,kJAAM,CAAC,MAAM,CAAC;IAAE,MAAM;AAAa;AAEnC,iCAAiC;AACjC,MAAM,mBAAmB,QAAQ,GAAG,CAAC,YAAY,IAAI,QAAQ,GAAG,CAAC,iBAAiB;AAElF,IAAI,CAAC,kBAAkB;IACrB,QAAQ,KAAK,CAAC;IACd,QAAQ,KAAK,CAAC;IACd,QAAQ,KAAK,CAAC;AAChB;AAEA,2BAA2B;AAC3B,MAAM,OAAO,IAAI,gKAAI,CAAC;IACpB,kBAAkB;AACpB;AAGO,eAAe;IACpB,IAAI;QACF,MAAM,SAAS,MAAM,KAAK,OAAO;QACjC,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC;QAClC,OAAO,OAAO;QACd,QAAQ,GAAG,CAAC,oCAAoC,OAAO,IAAI,CAAC,EAAE;QAC9D,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO;IACT;AACF;AAGO,eAAe,MAAM,IAAI,EAAE,MAAM;IACtC,IAAI,CAAC,kBAAkB;QACrB,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,QAAQ,KAAK,CAAC,UAAU;QACxB,QAAQ,KAAK,CAAC,WAAW;QACzB,MAAM;IACR,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAGO,eAAe;IACpB,IAAI;QACF,kCAAkC;QAClC,IAAI,CAAC,kBAAkB;YACrB,MAAM,IAAI,MAAM;QAClB;QAEA,QAAQ,GAAG,CAAC;QACZ,MAAM,YAAY,MAAM;QACxB,IAAI,CAAC,WAAW;YACd,MAAM,IAAI,MAAM;QAClB;QAEA,QAAQ,GAAG,CAAC;QAEZ,2BAA2B;QAC3B,QAAQ,GAAG,CAAC;QACZ,MAAM,MAAM,CAAC;;;;;;;;;;;;;IAab,CAAC;QACD,QAAQ,GAAG,CAAC;QAEZ,mDAAmD;QACnD,QAAQ,GAAG,CAAC;QACZ,MAAM,MAAM,CAAC;;;;;;;;IAQb,CAAC;QACD,QAAQ,GAAG,CAAC;QAEZ,wBAAwB;QACxB,QAAQ,GAAG,CAAC;QACZ,MAAM,MAAM,CAAC;;;;;;;;;;;;;;;;;;;;IAoBb,CAAC;QACD,QAAQ,GAAG,CAAC;QAEZ,wDAAwD;QACxD,QAAQ,GAAG,CAAC;QACZ,MAAM,MAAM,CAAC;;;;;;;;;;;IAWb,CAAC;QACD,QAAQ,GAAG,CAAC;QAEZ,wCAAwC;QACxC,QAAQ,GAAG,CAAC;QACZ,IAAI;YACF,MAAM,MAAM,CAAC,0DAA0D,CAAC;YACxE,MAAM,MAAM,CAAC,6EAA6E,CAAC;YAC3F,MAAM,MAAM,CAAC,oEAAoE,CAAC;YAClF,MAAM,MAAM,CAAC,gFAAgF,CAAC;YAC9F,MAAM,MAAM,CAAC,oFAAoF,CAAC;YAClG,QAAQ,GAAG,CAAC;QACd,EAAE,OAAO,YAAY;YACnB,QAAQ,GAAG,CAAC,0CAA0C,WAAW,OAAO;QAC1E;QAEA,QAAQ,GAAG,CAAC;QACZ,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,QAAQ,KAAK,CAAC,kBAAkB;YAC9B,SAAS,MAAM,OAAO;YACtB,MAAM,MAAM,IAAI;YAChB,QAAQ,MAAM,MAAM;QACtB;QACA,MAAM;IACR;AACF;uCAEe","debugId":null}},
    {"offset": {"line": 246, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/erpai/projects/UI/luminate-clinician/src/lib/auth.js"],"sourcesContent":["import bcrypt from 'bcryptjs';\r\nimport { query } from './db.js';\r\n\r\n// Hash password\r\nexport async function hashPassword(password) {\r\n  const saltRounds = 12;\r\n  return await bcrypt.hash(password, saltRounds);\r\n}\r\n\r\n// Verify password\r\nexport async function verifyPassword(password, hashedPassword) {\r\n  return await bcrypt.compare(password, hashedPassword);\r\n}\r\n\r\n// Generate a simple session token (in production, use a proper JWT library)\r\nexport function generateSessionToken() {\r\n  return Math.random().toString(36).substring(2) + Date.now().toString(36);\r\n}\r\n\r\n// Create user session\r\nexport async function createUserSession(userId) {\r\n  const sessionToken = generateSessionToken();\r\n  const expiresAt = new Date();\r\n  expiresAt.setDate(expiresAt.getDate() + 7); // 7 days from now\r\n\r\n  await query(\r\n    'INSERT INTO user_sessions (user_id, session_token, expires_at) VALUES ($1, $2, $3)',\r\n    [userId, sessionToken, expiresAt]\r\n  );\r\n\r\n  return sessionToken;\r\n}\r\n\r\n// Get user by session token\r\nexport async function getUserBySession(sessionToken) {\r\n  const result = await query(\r\n    `SELECT u.*, s.expires_at \r\n     FROM users u \r\n     JOIN user_sessions s ON u.id = s.user_id \r\n     WHERE s.session_token = $1 AND s.expires_at > NOW() AND u.is_active = true`,\r\n    [sessionToken]\r\n  );\r\n\r\n  return result.rows[0] || null;\r\n}\r\n\r\n// Clean up expired sessions\r\nexport async function cleanupExpiredSessions() {\r\n  await query('DELETE FROM user_sessions WHERE expires_at < NOW()');\r\n}\r\n\r\n// Get user by email\r\nexport async function getUserByEmail(email) {\r\n  const result = await query(\r\n    'SELECT * FROM users WHERE email = $1 AND is_active = true',\r\n    [email]\r\n  );\r\n  return result.rows[0] || null;\r\n}\r\n\r\n// Create new user\r\nexport async function createUser(userData) {\r\n  const { firstName, lastName, email, password, role, licenseNumber } = userData;\r\n  \r\n  const passwordHash = await hashPassword(password);\r\n  \r\n  const result = await query(\r\n    `INSERT INTO users (first_name, last_name, email, password_hash, role, license_number) \r\n     VALUES ($1, $2, $3, $4, $5, $6) \r\n     RETURNING id, first_name, last_name, email, role, created_at`,\r\n    [firstName, lastName, email, passwordHash, role, licenseNumber || null]\r\n  );\r\n\r\n  return result.rows[0];\r\n}\r\n\r\n// Validate user credentials\r\nexport async function validateUser(email, password) {\r\n  const user = await getUserByEmail(email);\r\n  if (!user) {\r\n    return null;\r\n  }\r\n\r\n  const isValidPassword = await verifyPassword(password, user.password_hash);\r\n  if (!isValidPassword) {\r\n    return null;\r\n  }\r\n\r\n  // Return user without password hash\r\n  const { password_hash, ...userWithoutPassword } = user;\r\n  return userWithoutPassword;\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA;AACA;;;AAGO,eAAe,aAAa,QAAQ;IACzC,MAAM,aAAa;IACnB,OAAO,MAAM,8IAAM,CAAC,IAAI,CAAC,UAAU;AACrC;AAGO,eAAe,eAAe,QAAQ,EAAE,cAAc;IAC3D,OAAO,MAAM,8IAAM,CAAC,OAAO,CAAC,UAAU;AACxC;AAGO,SAAS;IACd,OAAO,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,SAAS,CAAC,KAAK,KAAK,GAAG,GAAG,QAAQ,CAAC;AACvE;AAGO,eAAe,kBAAkB,MAAM;IAC5C,MAAM,eAAe;IACrB,MAAM,YAAY,IAAI;IACtB,UAAU,OAAO,CAAC,UAAU,OAAO,KAAK,IAAI,kBAAkB;IAE9D,MAAM,IAAA,2HAAK,EACT,sFACA;QAAC;QAAQ;QAAc;KAAU;IAGnC,OAAO;AACT;AAGO,eAAe,iBAAiB,YAAY;IACjD,MAAM,SAAS,MAAM,IAAA,2HAAK,EACxB,CAAC;;;+EAG0E,CAAC,EAC5E;QAAC;KAAa;IAGhB,OAAO,OAAO,IAAI,CAAC,EAAE,IAAI;AAC3B;AAGO,eAAe;IACpB,MAAM,IAAA,2HAAK,EAAC;AACd;AAGO,eAAe,eAAe,KAAK;IACxC,MAAM,SAAS,MAAM,IAAA,2HAAK,EACxB,6DACA;QAAC;KAAM;IAET,OAAO,OAAO,IAAI,CAAC,EAAE,IAAI;AAC3B;AAGO,eAAe,WAAW,QAAQ;IACvC,MAAM,EAAE,SAAS,EAAE,QAAQ,EAAE,KAAK,EAAE,QAAQ,EAAE,IAAI,EAAE,aAAa,EAAE,GAAG;IAEtE,MAAM,eAAe,MAAM,aAAa;IAExC,MAAM,SAAS,MAAM,IAAA,2HAAK,EACxB,CAAC;;iEAE4D,CAAC,EAC9D;QAAC;QAAW;QAAU;QAAO;QAAc;QAAM,iBAAiB;KAAK;IAGzE,OAAO,OAAO,IAAI,CAAC,EAAE;AACvB;AAGO,eAAe,aAAa,KAAK,EAAE,QAAQ;IAChD,MAAM,OAAO,MAAM,eAAe;IAClC,IAAI,CAAC,MAAM;QACT,OAAO;IACT;IAEA,MAAM,kBAAkB,MAAM,eAAe,UAAU,KAAK,aAAa;IACzE,IAAI,CAAC,iBAAiB;QACpB,OAAO;IACT;IAEA,oCAAoC;IACpC,MAAM,EAAE,aAAa,EAAE,GAAG,qBAAqB,GAAG;IAClD,OAAO;AACT","debugId":null}},
    {"offset": {"line": 407, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/erpai/projects/UI/luminate-clinician/src/lib/email.js"],"sourcesContent":["import nodemailer from 'nodemailer';\nimport dotenv from 'dotenv';\n\ndotenv.config({ path: '.env.local' });\n\n// Email configuration\nconst createTransporter = () => {\n  // For development, we'll use Gmail SMTP\n  // In production, you might want to use SendGrid, AWS SES, or other services\n  return nodemailer.createTransport({\n    service: 'gmail',\n    auth: {\n      user: process.env.EMAIL_USER,\n      pass: process.env.EMAIL_APP_PASSWORD, // Use App Password for Gmail\n    },\n  });\n};\n\n// Welcome email template\nexport const createWelcomeEmailTemplate = (patient) => {\n  const { name, email, therapist, totalSessions } = patient;\n  \n  return {\n    from: `\"Luminate Clinician\" <${process.env.EMAIL_USER}>`,\n    to: email,\n    subject: `Welcome to Luminate Clinician - Your Treatment Journey Begins!`,\n    html: `\n      <!DOCTYPE html>\n      <html lang=\"en\">\n      <head>\n        <meta charset=\"UTF-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        <title>Welcome to Luminate Clinician</title>\n        <style>\n          body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            line-height: 1.6;\n            color: #333;\n            max-width: 600px;\n            margin: 0 auto;\n            padding: 20px;\n            background-color: #f8fafc;\n          }\n          .container {\n            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);\n            border-radius: 20px;\n            padding: 40px;\n            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);\n          }\n          .header {\n            text-align: center;\n            margin-bottom: 30px;\n          }\n          .logo {\n            font-size: 32px;\n            font-weight: bold;\n            background: linear-gradient(135deg, #06b6d4, #10b981);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            background-clip: text;\n            margin-bottom: 10px;\n          }\n          .welcome-title {\n            color: #ffffff;\n            font-size: 28px;\n            margin-bottom: 10px;\n            font-weight: 600;\n          }\n          .welcome-subtitle {\n            color: #94a3b8;\n            font-size: 16px;\n            margin-bottom: 30px;\n          }\n          .content {\n            background: rgba(255, 255, 255, 0.05);\n            border-radius: 15px;\n            padding: 30px;\n            margin-bottom: 30px;\n            border: 1px solid rgba(255, 255, 255, 0.1);\n          }\n          .greeting {\n            color: #ffffff;\n            font-size: 18px;\n            margin-bottom: 20px;\n          }\n          .info-section {\n            background: rgba(6, 182, 212, 0.1);\n            border-radius: 10px;\n            padding: 20px;\n            margin: 20px 0;\n            border-left: 4px solid #06b6d4;\n          }\n          .info-title {\n            color: #06b6d4;\n            font-weight: 600;\n            margin-bottom: 10px;\n            font-size: 16px;\n          }\n          .info-text {\n            color: #e2e8f0;\n            margin-bottom: 8px;\n          }\n          .cta-button {\n            display: inline-block;\n            background: linear-gradient(135deg, #06b6d4, #10b981);\n            color: white;\n            padding: 15px 30px;\n            text-decoration: none;\n            border-radius: 10px;\n            font-weight: 600;\n            text-align: center;\n            margin: 20px 0;\n            transition: transform 0.3s ease;\n          }\n          .cta-button:hover {\n            transform: translateY(-2px);\n          }\n          .footer {\n            text-align: center;\n            color: #64748b;\n            font-size: 14px;\n            margin-top: 30px;\n            padding-top: 20px;\n            border-top: 1px solid rgba(255, 255, 255, 0.1);\n          }\n          .highlight {\n            color: #06b6d4;\n            font-weight: 600;\n          }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <div class=\"header\">\n            <div class=\"logo\">Luminate Clinician</div>\n            <h1 class=\"welcome-title\">Welcome to Your Treatment Journey!</h1>\n            <p class=\"welcome-subtitle\">Your personalized healthcare experience starts now</p>\n          </div>\n          \n          <div class=\"content\">\n            <p class=\"greeting\">Dear <span class=\"highlight\">${name}</span>,</p>\n            \n            <p style=\"color: #e2e8f0; margin-bottom: 20px;\">\n              Welcome to Luminate Clinician! We're thrilled to have you as part of our healthcare family. \n              Your treatment journey has been carefully planned and personalized just for you.\n            </p>\n            \n            <div class=\"info-section\">\n              <div class=\"info-title\">📋 Your Treatment Details</div>\n              <div class=\"info-text\"><strong>Therapist:</strong> ${therapist || 'To be assigned'}</div>\n              <div class=\"info-text\"><strong>Total Sessions:</strong> ${totalSessions || 'To be determined'}</div>\n              <div class=\"info-text\"><strong>Status:</strong> <span class=\"highlight\">Ready to Begin</span></div>\n            </div>\n            \n            <p style=\"color: #e2e8f0; margin: 20px 0;\">\n              Our team is committed to providing you with the highest quality care and support throughout your treatment. \n              You'll receive regular updates about your progress and any important information about your sessions.\n            </p>\n            \n            <div style=\"text-align: center; margin: 30px 0;\">\n              <a href=\"#\" class=\"cta-button\">Access Your Patient Portal</a>\n            </div>\n            \n            <p style=\"color: #e2e8f0; font-size: 14px; margin-top: 20px;\">\n              If you have any questions or need assistance, please don't hesitate to contact our support team. \n              We're here to help you every step of the way.\n            </p>\n          </div>\n          \n          <div class=\"footer\">\n            <p>© 2024 Luminate Clinician. All rights reserved.</p>\n            <p>This email was sent to ${email}. If you believe this is an error, please contact us.</p>\n          </div>\n        </div>\n      </body>\n      </html>\n    `,\n    text: `\n      Welcome to Luminate Clinician!\n      \n      Dear ${name},\n      \n      Welcome to Luminate Clinician! We're thrilled to have you as part of our healthcare family. \n      Your treatment journey has been carefully planned and personalized just for you.\n      \n      Your Treatment Details:\n      - Therapist: ${therapist || 'To be assigned'}\n      - Total Sessions: ${totalSessions || 'To be determined'}\n      - Status: Ready to Begin\n      \n      Our team is committed to providing you with the highest quality care and support throughout your treatment. \n      You'll receive regular updates about your progress and any important information about your sessions.\n      \n      If you have any questions or need assistance, please don't hesitate to contact our support team. \n      We're here to help you every step of the way.\n      \n      Best regards,\n      The Luminate Clinician Team\n      \n      © 2024 Luminate Clinician. All rights reserved.\n    `\n  };\n};\n\n// Send welcome email\nexport const sendWelcomeEmail = async (patient) => {\n  try {\n    // Check if email configuration is available\n    if (!process.env.EMAIL_USER || !process.env.EMAIL_APP_PASSWORD) {\n      console.warn('Email configuration missing. Skipping email send.');\n      console.log('EMAIL_USER:', process.env.EMAIL_USER ? 'Set' : 'Missing');\n      console.log('EMAIL_APP_PASSWORD:', process.env.EMAIL_APP_PASSWORD ? 'Set' : 'Missing');\n      return { success: false, error: 'Email configuration missing' };\n    }\n\n    console.log('Attempting to send welcome email to:', patient.email);\n    const transporter = createTransporter();\n    const emailTemplate = createWelcomeEmailTemplate(patient);\n    \n    const result = await transporter.sendMail(emailTemplate);\n    console.log('Welcome email sent successfully:', result.messageId);\n    \n    return { \n      success: true, \n      messageId: result.messageId,\n      message: 'Welcome email sent successfully'\n    };\n  } catch (error) {\n    console.error('Error sending welcome email:', error);\n    console.error('Error details:', {\n      message: error.message,\n      code: error.code,\n      response: error.response\n    });\n    return { \n      success: false, \n      error: error.message,\n      message: 'Failed to send welcome email'\n    };\n  }\n};\n\n// Patient login credentials email template\nexport const createPatientCredentialsEmailTemplate = (patient, credentials) => {\n  const { name, email, therapist } = patient;\n  const { username, password } = credentials;\n  \n  return {\n    from: `\"Luminate Clinician\" <${process.env.EMAIL_USER}>`,\n    to: email,\n    subject: `Your Patient Portal Access - Luminate Clinician`,\n    html: `\n      <!DOCTYPE html>\n      <html lang=\"en\">\n      <head>\n        <meta charset=\"UTF-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        <title>Patient Portal Access - Luminate Clinician</title>\n        <style>\n          body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            line-height: 1.6;\n            color: #333;\n            max-width: 600px;\n            margin: 0 auto;\n            padding: 20px;\n            background-color: #f8fafc;\n          }\n          .container {\n            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);\n            border-radius: 20px;\n            padding: 40px;\n            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);\n          }\n          .header {\n            text-align: center;\n            margin-bottom: 30px;\n          }\n          .logo {\n            font-size: 32px;\n            font-weight: bold;\n            background: linear-gradient(135deg, #06b6d4, #10b981);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            background-clip: text;\n            margin-bottom: 10px;\n          }\n          .title {\n            color: #ffffff;\n            font-size: 28px;\n            margin-bottom: 10px;\n            font-weight: 600;\n          }\n          .subtitle {\n            color: #94a3b8;\n            font-size: 16px;\n            margin-bottom: 30px;\n          }\n          .content {\n            background: rgba(255, 255, 255, 0.05);\n            border-radius: 15px;\n            padding: 30px;\n            margin-bottom: 30px;\n            border: 1px solid rgba(255, 255, 255, 0.1);\n          }\n          .greeting {\n            color: #ffffff;\n            font-size: 18px;\n            margin-bottom: 20px;\n          }\n          .credentials-box {\n            background: rgba(6, 182, 212, 0.1);\n            border: 2px solid #06b6d4;\n            border-radius: 15px;\n            padding: 25px;\n            margin: 25px 0;\n            text-align: center;\n          }\n          .credentials-title {\n            color: #06b6d4;\n            font-weight: 600;\n            margin-bottom: 15px;\n            font-size: 18px;\n          }\n          .credential-item {\n            background: rgba(0, 0, 0, 0.3);\n            border-radius: 10px;\n            padding: 15px;\n            margin: 10px 0;\n            border: 1px solid rgba(255, 255, 255, 0.1);\n          }\n          .credential-label {\n            color: #94a3b8;\n            font-size: 14px;\n            margin-bottom: 5px;\n          }\n          .credential-value {\n            color: #ffffff;\n            font-size: 20px;\n            font-weight: bold;\n            font-family: 'Courier New', monospace;\n            letter-spacing: 1px;\n          }\n          .cta-button {\n            display: inline-block;\n            background: linear-gradient(135deg, #06b6d4, #10b981);\n            color: white;\n            padding: 15px 30px;\n            text-decoration: none;\n            border-radius: 10px;\n            font-weight: 600;\n            text-align: center;\n            margin: 20px 0;\n            transition: transform 0.3s ease;\n          }\n          .cta-button:hover {\n            transform: translateY(-2px);\n          }\n          .security-notice {\n            background: rgba(239, 68, 68, 0.1);\n            border: 1px solid #ef4444;\n            border-radius: 10px;\n            padding: 15px;\n            margin: 20px 0;\n          }\n          .security-title {\n            color: #ef4444;\n            font-weight: 600;\n            margin-bottom: 10px;\n          }\n          .security-text {\n            color: #fca5a5;\n            font-size: 14px;\n          }\n          .footer {\n            text-align: center;\n            color: #64748b;\n            font-size: 14px;\n            margin-top: 30px;\n            padding-top: 20px;\n            border-top: 1px solid rgba(255, 255, 255, 0.1);\n          }\n          .highlight {\n            color: #06b6d4;\n            font-weight: 600;\n          }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <div class=\"header\">\n            <div class=\"logo\">Luminate Clinician</div>\n            <h1 class=\"title\">Your Patient Portal Access</h1>\n            <p class=\"subtitle\">Secure login credentials for your treatment journey</p>\n          </div>\n          \n          <div class=\"content\">\n            <p class=\"greeting\">Dear <span class=\"highlight\">${name}</span>,</p>\n            \n            <p style=\"color: #e2e8f0; margin-bottom: 20px;\">\n              Welcome to your personalized patient portal! We've created secure login credentials \n              so you can access your treatment information, track your progress, and communicate \n              with your healthcare team.\n            </p>\n            \n            <div class=\"credentials-box\">\n              <div class=\"credentials-title\">🔐 Your Login Credentials</div>\n              <div class=\"credential-item\">\n                <div class=\"credential-label\">Username</div>\n                <div class=\"credential-value\">${username}</div>\n              </div>\n              <div class=\"credential-item\">\n                <div class=\"credential-label\">Password</div>\n                <div class=\"credential-value\">${password}</div>\n              </div>\n            </div>\n            \n            <div style=\"text-align: center; margin: 30px 0;\">\n              <a href=\"#\" class=\"cta-button\">Access Your Patient Portal</a>\n            </div>\n            \n            <div class=\"security-notice\">\n              <div class=\"security-title\">🔒 Security Notice</div>\n              <div class=\"security-text\">\n                • Keep your login credentials secure and don't share them with anyone<br>\n                • You can change your password after your first login<br>\n                • If you suspect unauthorized access, contact us immediately<br>\n                • These credentials are unique to your account\n              </div>\n            </div>\n            \n            <p style=\"color: #e2e8f0; margin: 20px 0;\">\n              <strong>Your Treatment Team:</strong><br>\n              <span class=\"highlight\">Therapist:</span> ${therapist || 'To be assigned'}<br>\n              <span class=\"highlight\">Status:</span> Active Treatment\n            </p>\n            \n            <p style=\"color: #e2e8f0; font-size: 14px; margin-top: 20px;\">\n              If you have any questions or need assistance accessing your portal, \n              please don't hesitate to contact our support team.\n            </p>\n          </div>\n          \n          <div class=\"footer\">\n            <p>© 2024 Luminate Clinician. All rights reserved.</p>\n            <p>This email contains sensitive information. Please keep it secure.</p>\n          </div>\n        </div>\n      </body>\n      </html>\n    `,\n    text: `\n      Patient Portal Access - Luminate Clinician\n      \n      Dear ${name},\n      \n      Welcome to your personalized patient portal! We've created secure login credentials \n      so you can access your treatment information, track your progress, and communicate \n      with your healthcare team.\n      \n      Your Login Credentials:\n      ======================\n      Username: ${username}\n      Password: ${password}\n      \n      Security Notice:\n      - Keep your login credentials secure and don't share them with anyone\n      - You can change your password after your first login\n      - If you suspect unauthorized access, contact us immediately\n      - These credentials are unique to your account\n      \n      Your Treatment Team:\n      - Therapist: ${therapist || 'To be assigned'}\n      - Status: Active Treatment\n      \n      If you have any questions or need assistance accessing your portal, \n      please don't hesitate to contact our support team.\n      \n      Best regards,\n      The Luminate Clinician Team\n      \n      © 2024 Luminate Clinician. All rights reserved.\n    `\n  };\n};\n\n// Send patient login credentials email\nexport const sendPatientCredentialsEmail = async (patient, credentials) => {\n  try {\n    if (!process.env.EMAIL_USER || !process.env.EMAIL_APP_PASSWORD) {\n      console.warn('Email configuration missing. Skipping credentials email send.');\n      return { success: false, error: 'Email configuration missing' };\n    }\n\n    console.log('Sending patient credentials email to:', patient.email);\n    const transporter = createTransporter();\n    const emailTemplate = createPatientCredentialsEmailTemplate(patient, credentials);\n    \n    const result = await transporter.sendMail(emailTemplate);\n    console.log('Patient credentials email sent successfully:', result.messageId);\n    \n    return { \n      success: true, \n      messageId: result.messageId,\n      message: 'Patient credentials email sent successfully'\n    };\n  } catch (error) {\n    console.error('Error sending patient credentials email:', error);\n    console.error('Error details:', {\n      message: error.message,\n      code: error.code,\n      response: error.response\n    });\n    return { \n      success: false, \n      error: error.message,\n      message: 'Failed to send patient credentials email'\n    };\n  }\n};\n\n// Test email configuration\nexport const testEmailConfiguration = async () => {\n  try {\n    if (!process.env.EMAIL_USER || !process.env.EMAIL_APP_PASSWORD) {\n      return { success: false, error: 'Email configuration missing' };\n    }\n\n    const transporter = createTransporter();\n    await transporter.verify();\n    \n    return { success: true, message: 'Email configuration is valid' };\n  } catch (error) {\n    console.error('Email configuration test failed:', error);\n    return { success: false, error: error.message };\n  }\n};\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 957, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/erpai/projects/UI/luminate-clinician/src/lib/patientAuth.js"],"sourcesContent":["import bcrypt from 'bcryptjs';\r\nimport { query } from './db.js';\r\n\r\n// Generate unique username for patient\r\nexport const generatePatientUsername = async (patientName, patientId) => {\r\n  // Create base username from patient name\r\n  const baseName = patientName\r\n    .toLowerCase()\r\n    .replace(/[^a-z0-9]/g, '')\r\n    .substring(0, 8);\r\n  \r\n  let username = baseName;\r\n  let counter = 1;\r\n  \r\n  // Check if username exists and make it unique\r\n  while (true) {\r\n    const result = await query(\r\n      'SELECT id FROM patient_users WHERE username = $1',\r\n      [username]\r\n    );\r\n    \r\n    if (result.rows.length === 0) {\r\n      break; // Username is unique\r\n    }\r\n    \r\n    username = `${baseName}${counter}`;\r\n    counter++;\r\n  }\r\n  \r\n  return username;\r\n};\r\n\r\n// Generate secure password\r\nexport const generatePatientPassword = () => {\r\n  const length = 12;\r\n  const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';\r\n  let password = '';\r\n  \r\n  // Ensure at least one character from each category\r\n  const lowercase = 'abcdefghijklmnopqrstuvwxyz';\r\n  const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';\r\n  const numbers = '0123456789';\r\n  const symbols = '!@#$%^&*';\r\n  \r\n  password += lowercase[Math.floor(Math.random() * lowercase.length)];\r\n  password += uppercase[Math.floor(Math.random() * uppercase.length)];\r\n  password += numbers[Math.floor(Math.random() * numbers.length)];\r\n  password += symbols[Math.floor(Math.random() * symbols.length)];\r\n  \r\n  // Fill the rest randomly\r\n  for (let i = 4; i < length; i++) {\r\n    password += charset[Math.floor(Math.random() * charset.length)];\r\n  }\r\n  \r\n  // Shuffle the password\r\n  return password.split('').sort(() => Math.random() - 0.5).join('');\r\n};\r\n\r\n// Create patient user account\r\nexport const createPatientUser = async (patientId, patientName) => {\r\n  try {\r\n    // Generate credentials\r\n    const username = await generatePatientUsername(patientName, patientId);\r\n    const password = generatePatientPassword();\r\n    \r\n    // Hash the password\r\n    const saltRounds = 12;\r\n    const passwordHash = await bcrypt.hash(password, saltRounds);\r\n    \r\n    // Insert into patient_users table\r\n    const result = await query(\r\n      `INSERT INTO patient_users (patient_id, username, password_hash)\r\n       VALUES ($1, $2, $3)\r\n       RETURNING id, username, created_at`,\r\n      [patientId, username, passwordHash]\r\n    );\r\n    \r\n    const patientUser = result.rows[0];\r\n    \r\n    return {\r\n      success: true,\r\n      patientUser: {\r\n        id: patientUser.id,\r\n        patientId: patientId,\r\n        username: username,\r\n        password: password, // Return plain password for email\r\n        createdAt: patientUser.created_at\r\n      }\r\n    };\r\n  } catch (error) {\r\n    console.error('Error creating patient user:', error);\r\n    return {\r\n      success: false,\r\n      error: error.message\r\n    };\r\n  }\r\n};\r\n\r\n// Authenticate patient user\r\nexport const authenticatePatient = async (username, password) => {\r\n  try {\r\n    // Get patient user with patient details\r\n    const result = await query(\r\n      `SELECT \r\n        pu.id, pu.patient_id, pu.username, pu.password_hash, pu.is_active,\r\n        p.name, p.email, p.diagnosis, p.therapist, p.total_sessions, p.sessions_completed\r\n       FROM patient_users pu\r\n       JOIN patients p ON pu.patient_id = p.id\r\n       WHERE pu.username = $1 AND pu.is_active = true`,\r\n      [username]\r\n    );\r\n    \r\n    if (result.rows.length === 0) {\r\n      return { success: false, error: 'Invalid credentials' };\r\n    }\r\n    \r\n    const patientUser = result.rows[0];\r\n    \r\n    // Verify password\r\n    const isValidPassword = await bcrypt.compare(password, patientUser.password_hash);\r\n    \r\n    if (!isValidPassword) {\r\n      return { success: false, error: 'Invalid credentials' };\r\n    }\r\n    \r\n    // Update last login\r\n    await query(\r\n      'UPDATE patient_users SET last_login = CURRENT_TIMESTAMP WHERE id = $1',\r\n      [patientUser.id]\r\n    );\r\n    \r\n    return {\r\n      success: true,\r\n      patient: {\r\n        id: patientUser.patient_id,\r\n        name: patientUser.name,\r\n        email: patientUser.email,\r\n        diagnosis: patientUser.diagnosis,\r\n        therapist: patientUser.therapist,\r\n        totalSessions: patientUser.total_sessions,\r\n        sessionsCompleted: patientUser.sessions_completed\r\n      },\r\n      user: {\r\n        id: patientUser.id,\r\n        username: patientUser.username\r\n      }\r\n    };\r\n  } catch (error) {\r\n    console.error('Error authenticating patient:', error);\r\n    return {\r\n      success: false,\r\n      error: 'Authentication failed'\r\n    };\r\n  }\r\n};\r\n\r\n// Get patient user by patient ID\r\nexport const getPatientUserByPatientId = async (patientId) => {\r\n  try {\r\n    const result = await query(\r\n      `SELECT pu.id, pu.username, pu.is_active, pu.last_login, pu.created_at\r\n       FROM patient_users pu\r\n       WHERE pu.patient_id = $1`,\r\n      [patientId]\r\n    );\r\n    \r\n    if (result.rows.length === 0) {\r\n      return { success: false, error: 'Patient user not found' };\r\n    }\r\n    \r\n    return {\r\n      success: true,\r\n      patientUser: result.rows[0]\r\n    };\r\n  } catch (error) {\r\n    console.error('Error getting patient user:', error);\r\n    return {\r\n      success: false,\r\n      error: error.message\r\n    };\r\n  }\r\n};\r\n\r\n// Update patient password\r\nexport const updatePatientPassword = async (patientUserId, newPassword) => {\r\n  try {\r\n    const saltRounds = 12;\r\n    const passwordHash = await bcrypt.hash(newPassword, saltRounds);\r\n    \r\n    await query(\r\n      'UPDATE patient_users SET password_hash = $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2',\r\n      [passwordHash, patientUserId]\r\n    );\r\n    \r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error('Error updating patient password:', error);\r\n    return {\r\n      success: false,\r\n      error: error.message\r\n    };\r\n  }\r\n};\r\n\r\n// Deactivate patient user\r\nexport const deactivatePatientUser = async (patientUserId) => {\r\n  try {\r\n    await query(\r\n      'UPDATE patient_users SET is_active = false, updated_at = CURRENT_TIMESTAMP WHERE id = $1',\r\n      [patientUserId]\r\n    );\r\n    \r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error('Error deactivating patient user:', error);\r\n    return {\r\n      success: false,\r\n      error: error.message\r\n    };\r\n  }\r\n};\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1168, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/erpai/projects/UI/luminate-clinician/src/app/api/patients/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { query } from '@/lib/db';\nimport { getUserBySession } from '@/lib/auth';\nimport { sendWelcomeEmail, sendPatientCredentialsEmail } from '@/lib/email';\nimport { createPatientUser } from '@/lib/patientAuth';\n\n// GET - Fetch all patients for the authenticated user\nexport async function GET(request) {\n  try {\n    const sessionToken = request.cookies.get('session_token')?.value;\n\n    if (!sessionToken) {\n      return NextResponse.json(\n        { error: 'Not authenticated' },\n        { status: 401 }\n      );\n    }\n\n    const user = await getUserBySession(sessionToken);\n    if (!user) {\n      return NextResponse.json(\n        { error: 'Invalid or expired session' },\n        { status: 401 }\n      );\n    }\n\n    // Get all patients for this user\n    const result = await query(\n      `SELECT * FROM patients \n       WHERE user_id = $1 \n       ORDER BY created_at DESC`,\n      [user.id]\n    );\n\n    return NextResponse.json({\n      patients: result.rows.map(patient => ({\n        id: patient.id,\n        name: patient.name,\n        email: patient.email,\n        phone: patient.phone,\n        dateOfBirth: patient.date_of_birth,\n        diagnosis: patient.diagnosis,\n        medicalHistory: patient.medical_history,\n        emergencyContact: patient.emergency_contact,\n        emergencyPhone: patient.emergency_phone,\n        therapist: patient.therapist,\n        totalSessions: patient.total_sessions,\n        sessionsCompleted: patient.sessions_completed,\n        status: patient.status,\n        notes: patient.notes,\n        createdAt: patient.created_at,\n        updatedAt: patient.updated_at\n      }))\n    });\n\n  } catch (error) {\n    console.error('Get patients error:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n// POST - Create a new patient\nexport async function POST(request) {\n  try {\n    const sessionToken = request.cookies.get('session_token')?.value;\n\n    if (!sessionToken) {\n      return NextResponse.json(\n        { error: 'Not authenticated' },\n        { status: 401 }\n      );\n    }\n\n    const user = await getUserBySession(sessionToken);\n    if (!user) {\n      return NextResponse.json(\n        { error: 'Invalid or expired session' },\n        { status: 401 }\n      );\n    }\n\n    const body = await request.json();\n    const {\n      name,\n      email,\n      phone,\n      dateOfBirth,\n      diagnosis,\n      medicalHistory,\n      emergencyContact,\n      emergencyPhone,\n      therapist,\n      totalSessions,\n      notes\n    } = body;\n\n    // Validate required fields\n    if (!name || !diagnosis || !medicalHistory) {\n      return NextResponse.json(\n        { error: 'Name, diagnosis, and medical history are required' },\n        { status: 400 }\n      );\n    }\n\n    // Create new patient\n    const result = await query(\n      `INSERT INTO patients (\n        user_id, name, email, phone, date_of_birth, diagnosis, \n        medical_history, emergency_contact, emergency_phone, \n        therapist, total_sessions, notes\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)\n      RETURNING *`,\n      [\n        user.id,\n        name,\n        email || null,\n        phone || null,\n        dateOfBirth || null,\n        diagnosis,\n        medicalHistory,\n        emergencyContact || null,\n        emergencyPhone || null,\n        therapist || user.first_name + ' ' + user.last_name,\n        totalSessions || 12,\n        notes || null\n      ]\n    );\n\n    const newPatient = result.rows[0];\n\n    // Prepare patient data for email\n    const patientForEmail = {\n      id: newPatient.id,\n      name: newPatient.name,\n      email: newPatient.email,\n      phone: newPatient.phone,\n      dateOfBirth: newPatient.date_of_birth,\n      diagnosis: newPatient.diagnosis,\n      medicalHistory: newPatient.medical_history,\n      emergencyContact: newPatient.emergency_contact,\n      emergencyPhone: newPatient.emergency_phone,\n      therapist: newPatient.therapist,\n      totalSessions: newPatient.total_sessions,\n      sessionsCompleted: newPatient.sessions_completed,\n      status: newPatient.status,\n      notes: newPatient.notes,\n      createdAt: newPatient.created_at,\n      updatedAt: newPatient.updated_at\n    };\n\n    // Create patient user account and send credentials\n    let patientUserResult = null;\n    let credentialsEmailResult = null;\n    let welcomeEmailResult = null;\n\n    if (newPatient.email) {\n      try {\n        // Create patient user account\n        console.log('Creating patient user account...');\n        patientUserResult = await createPatientUser(newPatient.id, newPatient.name);\n        \n        if (patientUserResult.success) {\n          console.log('Patient user created:', patientUserResult.patientUser.username);\n          \n          // Send credentials email\n          console.log('Sending patient credentials email...');\n          credentialsEmailResult = await sendPatientCredentialsEmail(\n            patientForEmail, \n            {\n              username: patientUserResult.patientUser.username,\n              password: patientUserResult.patientUser.password\n            }\n          );\n          console.log('Credentials email result:', credentialsEmailResult);\n        } else {\n          console.error('Failed to create patient user:', patientUserResult.error);\n        }\n      } catch (error) {\n        console.error('Patient user creation failed (non-blocking):', error);\n        patientUserResult = { success: false, error: error.message };\n      }\n\n      // Also send welcome email\n      try {\n        console.log('Sending welcome email...');\n        welcomeEmailResult = await sendWelcomeEmail(patientForEmail);\n        console.log('Welcome email result:', welcomeEmailResult);\n      } catch (emailError) {\n        console.error('Welcome email sending failed (non-blocking):', emailError);\n        welcomeEmailResult = { success: false, error: emailError.message };\n      }\n    }\n\n    // Prepare response messages\n    const messages = [];\n    if (patientUserResult?.success) {\n      messages.push('Patient user account created');\n    } else if (patientUserResult?.error) {\n      messages.push(`User account creation failed: ${patientUserResult.error}`);\n    }\n    \n    if (credentialsEmailResult?.success) {\n      messages.push('Login credentials sent via email');\n    } else if (credentialsEmailResult?.error) {\n      messages.push(`Credentials email failed: ${credentialsEmailResult.error}`);\n    }\n    \n    if (welcomeEmailResult?.success) {\n      messages.push('Welcome email sent');\n    } else if (welcomeEmailResult?.error) {\n      messages.push(`Welcome email failed: ${welcomeEmailResult.error}`);\n    }\n\n    if (!newPatient.email) {\n      messages.push('No email provided - no user account or emails sent');\n    }\n\n    return NextResponse.json(\n      {\n        message: 'Patient created successfully',\n        patient: patientForEmail,\n        patientUserCreated: patientUserResult?.success || false,\n        credentialsEmailSent: credentialsEmailResult?.success || false,\n        welcomeEmailSent: welcomeEmailResult?.success || false,\n        details: messages.join('; '),\n        hasEmail: !!newPatient.email\n      },\n      { status: 201 }\n    );\n\n  } catch (error) {\n    console.error('Create patient error:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}